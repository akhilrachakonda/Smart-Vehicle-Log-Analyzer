version: '3.8'

# This Docker Compose file orchestrates the services for the Smart Vehicle Log Analyzer.
# It defines the backend service, a service to run the training scripts, and the frontend service.

services:
  # --- Training Service ---
  # This is a one-off service used to generate the data and train the model.
  # It ensures that the training environment is identical to the production environment.
  training:
    build:
      context: .
      dockerfile: Dockerfile # We can use the same Dockerfile
    command: >
      sh -c "python notebooks/generate_dataset.py && python notebooks/02_train_model.py"
    volumes:
      # Mount volumes to persist the generated data and model artifacts on the host.
      - ./data:/app/data
      - ./app/ml:/app/app/ml

  # --- Backend Service ---
  # This service runs the FastAPI application.
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000" # Map port 8000 on the host to port 8000 in the container
    volumes:
      # Mount the application code for live reloading during development.
      - ./app:/app/app
      # Mount the model artifacts generated by the training service.
      - ./app/ml:/app/app/ml
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    depends_on:
      - training # Ensures the training service runs and completes before the backend starts.

  # --- Frontend Service ---
  # This service runs the Streamlit UI.
  frontend:
    build:
      context: .
      dockerfile: Dockerfile # We can reuse the same base environment
    ports:
      - "8501:8501"
    volumes:
      # Mount the frontend code.
      - ./frontend:/app/frontend
    command: streamlit run frontend/app.py --server.port 8501 --server.address 0.0.0.0
    depends_on:
      - backend # Ensures the backend is running before the frontend starts.

volumes:
  data:
  ml_artifacts:
